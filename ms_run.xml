<?xml version="1.0" encoding="utf-8"?>
<tool id="fa_gc_content_1" name="Run MSGF+ on Proteome" version="0.1.0">
  <command interpreter="python3">runPipeline.py
  '$proteome'

  #for $p in $proteins
  --additional_proteome '$p.fasta'
  #end for

  #if str($search_type.search_type_selector) == 'filtered'
  #for $r in $search_type.mhcalleles
  --allele $r.allele.value
  #end for
  --pep_len '$search_type.length'
  --rank_filter '$search_type.rank_filter'
  #end if
  
  
  --num_matches_per_spectrum 1
  --mgf '$mgf'

  --frag_method '$frag_method'

  --instrument '$instrument'

  --output '$peptides'
  
  --archive '$Archive'
  
  &gt; $Log 2&gt;&amp;1
  </command>
  <inputs>

    <param name="proteome" type="select" label="Select a proteome">
      <options from_data_table="Proteomes" />
    </param>

    <repeat name="proteins" title="Add additional protein FASTA files">
      <param name="fasta" type="data" label="Select a FASTA file" format="fasta" />
    </repeat>

    <param name="mgf" type="data" label="Select an MGF file" format="mgf" />

    <param name="frag_method" type="select" label="Select the fragmentation method">
      <option value="0">CID</option>
      <option value="1">ETD</option>
      <option value="2">HCD</option>
    </param>

    <param name="instrument" type="select" label="Select the instrument">
      <option value="0">Low res LCQ/LTQ</option>
      <option value="1">High Res LCQ/LTQ</option>
      <option value="2">TOF</option>
      <option value="3">Q-Extractive</option>
    </param>

    <!--- <param name="num_matches_per_spectrum" type="integer" value="1" label="Number of matches per spectrum" /> -->
    <conditional name="search_type">
      <param name="search_type_selector" type="select" label="Choose search type">
	<option value="unfiltered" selected="true">Unfiltered Search</option>
	<option value="filtered">Filtered Search</option>
      </param>
      <when value="filtered">
	<repeat name="mhcalleles" title="Select MHC Alleles">
	  <param name="allele" type="select" label="Select an allele">
	    <options from_data_table="Alleles" />
	  </param>
	</repeat>
	<param name="length" type="select" display="checkboxes" label="Select peptide lengths" multiple="true">
	  <option value="8"></option>
	  <option value="9"></option>
	  <option value="10"></option>
	  <option value="11"></option>
	  <option value="12"></option>
	  <option value="13"></option>
	</param>
	<param name="rank_filter" type="float" min="0" max="100" value="2" label="Take top k percent of peptides from NetMHC" />
      </when>
    </conditional>
  </inputs>
  <outputs>
    <data format="tabular" name="peptides" label="Search of ${mgf.name}, NetMHC ${search_type.search_type_selector}, peptides"/>
    <!-- <data format="tabular" name="PSMs" label="Search of ${mgf.name}, NetMHC ${search_type.search_type_selector}, PSMs"/> -->
    <data name="Log" format="log"  label="Run MSGF+ Log" />
    <data name="Archive" format="zip" label="Archive" />
  </outputs>


  <tests>
    <test>
      <param name="input" value="fa_gc_content_input.fa"/>
      <output name="out_file1" file="fa_gc_content_output.txt"/>
    </test>
  </tests>         
  
  <help>
    The purpose of this tool is to run an MS-GF+ search using our pipeline. I'll go through each of the options and explain what they mean:

    First, there's the "select proteome" dropdown. You select the proteome you want to search against. Right now there are two options: the SwissProt human, and the SwissProt mouse. These are simply labeled as "Human" and "Mouse". More can be added by me (Jordan) if requested.

    Then, there's an option for adding additional protein FASTA files. How these are used depends on the tool's mode (NetMHC filtered on unfiltered).

    The fragmentation method and instrument should be self explanatory.

===============
Unfiltered Search
===============


    
    In this mode, the tool takes the base proteome, and concats any additional FASTA files to it. Then, it runs an MS-GF+ search against the resulting set of proteins. The following options are explicitly set in the MS-GF+ search (see: https://msgfplus.github.io/msgfplus/MSGFPlus.html)


+--------------------+------------------------------+----------------+------------------------------------------------+
| Search Param       | Description                  | Value          | Meaning of Value                               |
+--------------------+------------------------------+----------------+------------------------------------------------+
| -e                 |                              | 0              |                                                |
|                    | Enzyme to use when           |                | Unspecific cleavage. Breaks proteins into      |
|                    |                              |                |                                                |
|                    | generating proteome          |                | all possible peptides between                  |
|                    |                              |                |                                                |
|                    |                              |                | min and max length                             |
+--------------------+------------------------------+----------------+------------------------------------------------+
| -inst              |                              | User specified | Changes scoring function                       |
|                    | What instrument generated    |                |                                                |
|                    |                              |                |                                                |
|                    | the data                     |                |                                                |
+--------------------+------------------------------+----------------+------------------------------------------------+
| -m                 | Fragmentation method         | User specified | Changes scoring function                       |
+--------------------+------------------------------+----------------+------------------------------------------------+
| -n                 |                              | 1              |                                                |
|                    | Report top n peptides        |                | Only best scoring peptide reported             |
|                    | for each spectra             |                |                                                |
|                    |                              |                | for each spectra                               |
+--------------------+------------------------------+----------------+------------------------------------------------+
| -ignoreMetCleavage |                              | 1              |                                                |
|                    | Hidden option that controls  |                | Turns off meth cleavage. See:                  |
|                    | whether to cleave methionine |                | https://github.com/MSGFPlus/msgfplus/issues/51 |
|                    | from N-terminus of peptides  |                |                                                |
+--------------------+------------------------------+----------------+------------------------------------------------+

There are also some relevant parameters that aren't specified in the search, and left to default in MS-GF+:


+-------------------------+------------------------+---------------+---------------------------------+
| Search Param            | Description            | Default Value | Meaning of Value                |
+-------------------------+------------------------+---------------+---------------------------------+
| -precursorMassTolerance |                        | 20ppm         |                                 |
+-------------------------+------------------------+---------------+---------------------------------+
| -minLength              | Minimum peptide length | 6             |                                 |
|                         |                        |               | Will only consider              |
|                         |                        |               |                                 |
|                         |                        |               | peptides with length at least 6 |
+-------------------------+------------------------+---------------+---------------------------------+
| -maxLength              | Maximum peptide length | 40            |                                 |
|                         |                        |               | Will only consider peptides     |
|                         |                        |               | with length at most 40          |
+-------------------------+------------------------+---------------+---------------------------------+

===============
Filtered Mode
===============


For each MHC allele and peptide length, score the peptides in the proteome of that length, and take k percent best scoring. For example, if the MHC alleles are HLA-A0101 and HLA-B0702, and the checked lengths are 8, 9 and 10, and k is 2, then we would generate 6 different set of peptides:

* 2% highest scoring length 8 peptides for HLA-A0101
* 2% highest scoring length 9 peptides for HLA-A0101
* 2% highest scoring length 10 peptides for HLA-A0101
* 2% highest scoring length 8 peptides for HLA-B0702
* 2% highest scoring length 9 peptides for HLA-B0702
* 2% highest scoring length 10 peptides for HLA-B0702

Suppose there were 1000 peptides of length 8 in the proteome, 2000 peptides of length 9 in the proteome, and 4000 peptides of length 10 in the proteome. Then sets 1 and 4 would contain 20 peptides each, sets 2 and 5 would have 40 peptides each, and sets 3 and 6 would have 80 peptides each. It's possible that sets 1 and 4 could have overlap, that sets 2 and 5 could have overlap, and that sets 3 and 6 could have overlap. We would search the concatenation of these 6 peptide sets.

This is why we have a base proteome: All length 8-13 peptides in the base proteome have been pre-scored by NetMHC for each allele, so we don't have to re-do the scoring each time a search is done. When additional protein FASTA files are added, the proteins are broken into peptides (with lengths that depend on the user specified lengths), and added to the set of unfiltered peptides in the proteome. *Then* the top k NetMHC scoring peptides are taken for each allele-length combination.

Only one MS-GF+ search parameter changes: we use "-e 9" instead of "-e 0"; this tells MS-GF+ not to do any in-silico digestion. 
  </help>

</tool>


