<?xml version="1.0" encoding="utf-8"?>
<tool id="fa_gc_content_1" name="Run MSGF+ on Proteome" version="0.1.0">
  <command interpreter="python3">runPipeline.py
  '$proteome'

  #for $p in $proteins
  --additional_proteome '$p.fasta'
  #end for

  #if str($search_type.search_type_selector) == 'filtered'
  #for $r in $search_type.mhcalleles
  --allele $r.allele.value
  #end for
  --pep_len '$search_type.length'
  --rank_filter '$search_type.rank_filter'
  #end if
  
  
  --num_matches_per_spectrum 1
  --mgf '$mgf'

  --frag_method '$frag_method'

  --instrument '$instrument'

  --output '$peptides'
  
  --archive '$Archive'
  
  &gt; $Log 2&gt;&amp;1
  </command>
  <inputs>

    <param name="proteome" type="select" label="Select a proteome">
      <options from_data_table="Proteomes" />
    </param>

    <repeat name="proteins" title="Add additional protein FASTA files">
      <param name="fasta" type="data" label="Select a FASTA file" format="fasta" />
    </repeat>

    <param name="mgf" type="data" label="Select an MGF file" format="mgf" />

    <param name="frag_method" type="select" label="Select the fragmentation method">
      <option value="0">CID</option>
      <option value="1">ETD</option>
      <option value="2">HCD</option>
    </param>

    <param name="instrument" type="select" label="Select the instrument">
      <option value="0">Low res LCQ/LTQ</option>
      <option value="1">High Res LCQ/LTQ</option>
      <option value="2">TOF</option>
      <option value="3">Q-Extractive</option>
    </param>

    <!--- <param name="num_matches_per_spectrum" type="integer" value="1" label="Number of matches per spectrum" /> -->
    <conditional name="search_type">
      <param name="search_type_selector" type="select" label="Choose search type">
	<option value="unfiltered" selected="true">Unfiltered Search</option>
	<option value="filtered">Filtered Search</option>
      </param>
      <when value="filtered">
	<repeat name="mhcalleles" title="Select MHC Alleles">
	  <param name="allele" type="select" label="Select an allele">
	    <options from_data_table="Alleles" />
	  </param>
	</repeat>
	<param name="length" type="select" display="checkboxes" label="Select peptide lengths" multiple="true">
	  <option value="8"></option>
	  <option value="9"></option>
	  <option value="10"></option>
	  <option value="11"></option>
	  <option value="12"></option>
	  <option value="13"></option>
	</param>
	<param name="rank_filter" type="float" min="0" max="100" value="2" label="Take top k percent of peptides from NetMHC" />
      </when>
    </conditional>
  </inputs>
  <outputs>
    <data format="tabular" name="peptides" label="Search of ${mgf.name}, NetMHC ${search_type.search_type_selector}, peptides"/>
    <!-- <data format="tabular" name="PSMs" label="Search of ${mgf.name}, NetMHC ${search_type.search_type_selector}, PSMs"/> -->
    <data name="Log" format="log"  label="Run MSGF+ Log" />
    <data name="Archive" format="zip" label="Archive" />
  </outputs>


  <tests>
    <test>
      <param name="input" value="fa_gc_content_input.fa"/>
      <output name="out_file1" file="fa_gc_content_output.txt"/>
    </test>
  </tests>         
  
  <help>
    The purpose of this tool is to run an MS-GF+ search using our pipeline. I'll go through each of the options and explain what they mean:

    First, there's the "select proteome" dropdown. You select the proteome you want to search against. Right now there are two options: the SwissProt human, and the SwissProt mouse. These are simply labeled as "Human" and "Mouse". More can be added by me (Jordan) if requested.

    Then, there's an option for adding additional protein FASTA files. How these are used depends on the tool's mode (NetMHC filtered on unfiltered).

    The fragmentation method and instrument should be self explanatory.
    
    Unfiltered Search:

    
    In this mode, the tool takes the base proteome, and concats any additional FASTA files to it. Then, it runs an MS-GF+ search against the resulting set of proteins. The following options are explicitly set in the MS-GF+ search (see: https://msgfplus.github.io/msgfplus/MSGFPlus.html)

    
.--------------------.-------------------------------------------------------------------------------------------------------------------------------------------------------.----------------.-------------------------------------------------------------------------------------------.
|    Search Param    |                                                                      Description                                                                      |     Value      |                                     Meaning of Value                                      |
:--------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------+----------------+-------------------------------------------------------------------------------------------:
| -e                 | Enzyme to use when digesting the proteome                                                                                                             | 0              | Unspecific cleavage. Break proteins into all possible peptides between min and max length |
:--------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------+----------------+-------------------------------------------------------------------------------------------:
| -inst              | What instrument generated the data. This changes the scoring function                                                                                 | User specified | Depends on what user specifies                                                            |
:--------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------+----------------+-------------------------------------------------------------------------------------------:
| -m                 | Fragmentation method                                                                                                                                  | User specified | Depends on what user specifies                                                            |
:--------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------+----------------+-------------------------------------------------------------------------------------------:
| -n                 | Report top n scoring peptides for each spectra                                                                                                        | 1              | Only a single peptide outputted for each spectra                                          |
:--------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------+----------------+-------------------------------------------------------------------------------------------:
| -ignoreMetCleavage | Tells MS-GF+ to not cleave methionine from the N-terminus of peptides. This is a hidden option; see: https://github.com/MSGFPlus/msgfplus/issues/51   | 1              |                                                                                           |
:--------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------+----------------+-------------------------------------------------------------------------------------------:
| -addFeatures       | Turns on features for Percolator                                                                                                                      | 1              | Percolator features are added to MS-GF+ output                                            |
'--------------------'-------------------------------------------------------------------------------------------------------------------------------------------------------'----------------'-------------------------------------------------------------------------------------------'


  </help>

</tool>


